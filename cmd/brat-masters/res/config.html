<html>
	<head>
		<title> Brat's Overlay Configuration </title>
		<meta charset="utf-8" name="viewport" />

		<style>
			body {
				padding-left: 10%;
				padding-right: 10%;
				font-size: x-large;
			}
			div.hor {
				display: flex;
				flex-direction: row;
				justify-content: space-between;
				margin-bottom: 0.5em;
			}

			div.vert {
				display: flex;
				flex-direction: column;
			}

			label {
				flex-grow: 1;
			}
			select {
				flex-grow: 9;
				font-size: large;
			}
			input {
				flex-grow: 9;
				font-size: large;
			}
			input.pred {
				flex-grow: 1;
				margin-left: 1em;
				margin-right: 1em;
			}
			input.checkbox {
				height: 2.25em;
				flex-grow: 1;
			}
			label.checkbox {
				align-self: center;
				padding-left: 1em;
				flex-grow: 9;
			}
			input.timer {
				height: 4em;
				margin-left: 1em;
				margin-right: 1em;
			}
			input.set-time {
				margin-left: 0.5em;
				margin-right: 0.5em;
				text-align: center;
			}
		</style>

		<script type="text/javascript" src="/res/script/teams.js"></script>
		<script type="text/javascript" src="/res/script/conn.js"></script>
		<script type="text/javascript" src="/res/script/timer.js"></script>

		<script>

		const template_page = '/tmpl/overlay.go.html';

		/** The time at which the left timer was stopped. */
		let left_timer = null;
		/** The time at which the right timer was stopped. */
		let right_timer = null;

		/**
		 * set_val configures the value of element id,
		 * calling cb (if supplied) with the element afterwards.
		 */
		let set_val = function(id, value, cb=null) {
			let element = document.getElementById(id);
			element.value = value;

			if (cb) {
				cb(element);
			}
		}

		/**
		 * get_val retrieves the value of element id.
		 */
		let get_val = function(id) {
			let element = document.getElementById(id);
			return element.value;
		}

		/** Simple callback for suppressing a callback. */
		let ignore_cb = function(e) {}

		/**
		 * Send a POST request, handling errors and ignoring success.
		 */
		let send_with_errors = function(url, obj) {
			let data = JSON.stringify(obj);
			let _c = conn.newConn(url, 'POST', true);
			_c.send(data, ignore_cb, function(e) { alert(e); });
		}

		/**
		 * Send the current configuration to the remote server.
		 */
		let submit = function() {
			let data = {};

			data.LeftTeamWinCount = parseInt(get_val('left-team-win-count'));
			data.RightTeamWinCount = parseInt(get_val('right-team-win-count'));
			let left_team = get_val('left-team');
			data.LeftTeam = left_team;
			let left_team_members = [];
			if (left_team in teams) {
				left_team_members = teams[left_team];
			}
			data.LeftTeamMembers = left_team_members
			data.LeftRacer = get_val('left-racer');
			data.LeftTwitch = get_val('left-twitch');
			let right_team = get_val('right-team');
			data.RightTeam = right_team;
			if (right_team in teams) {
				right_team_members = teams[right_team];
			}
			data.RightTeamMembers = right_team_members
			data.RightRacer = get_val('right-racer');
			data.RightTwitch = get_val('right-twitch');
			data.Game = get_val('game');
			data.Goal = get_val('goal');
			data.NextLeftTeam = get_val('next-left-team');
			data.NextRightTeam = get_val('next-right-team');

			if (left_timer) {
				data.LeftTimer = left_timer;
			}
			if (right_timer) {
				data.RightTimer = right_timer;
			}

			send_with_errors(template_page, data);
		}

		/**
		 * Fill every field with whatever is currently at the server.
		 */
		let on_load = function(e) {
			data = JSON.parse(e);

			if ('LeftTeamWinCount' in data) {
				set_val('left-team-win-count', data.LeftTeamWinCount);
			}
			if ('RightTeamWinCount' in data) {
				set_val('right-team-win-count', data.RightTeamWinCount);
			}
			if ('LeftTeam' in data) {
				set_val('left-team', data.LeftTeam, on_set_team);
			}
			if ('LeftRacer' in data) {
				set_val('left-racer', data.LeftRacer);
			}
			if ('LeftTwitch' in data) {
				set_val('left-twitch', data.LeftTwitch);
			}
			if ('RightTeam' in data) {
				set_val('right-team', data.RightTeam, on_set_team);
			}
			if ('RightRacer' in data) {
				set_val('right-racer', data.RightRacer);
			}
			if ('RightTwitch' in data) {
				set_val('right-twitch', data.RightTwitch);
			}
			if ('Game' in data) {
				set_val('game', data.Game);
			}
			if ('Goal' in data) {
				set_val('goal', data.Goal);
			}
			if ('NextLeftTeam' in data) {
				set_val('next-left-team', data.NextLeftTeam);
			}
			if ('NextRightTeam' in data) {
				set_val('next-right-team', data.NextRightTeam);
			}

			if ('LeftTimer' in data) {
				left_timer = data.LeftTimer;
			}
			if ('RightTimer' in data) {
				right_timer = data.RightTimer;
			}
		}

		/**
		 * clear_stopped_timer clears the stopped timer locally.
		 */
		let clear_stopped_timer = function() {
			left_timer = null;
			right_timer = null;

			load_data(function(e) {
				data = JSON.parse(e);
				delete data.LeftTimer;
				delete data.RightTimer;

				send_with_errors(template_page, data);
			});
		}

		/**
		 * reset_time resets the race timer, cleaning up the starting time.
		 */
		let reset_time = function() {
			set_val('starting-time-sec', 0);
			set_val('starting-time-min', 0);

			timer.reset();
			clear_stopped_timer();
		}

		/**
		 * start_time starts the race timer.
		 */
		let start_time = function() {
			timer.start();
		}

		/**
		 * stop_time stops the race timer.
		 */
		let stop_time = function() {
			timer.stop();
		}

		/**
		 * toggle_time halts/continues a timer.
		 */
		let toggle_time = function(side) {
			timer.get(function(time) {
				load_data(function(e) {
					data = JSON.parse(e);

					if (side == 'left') {
						if ('LeftTimer' in data) {
							delete data.LeftTimer;
						}
						else {
							left_timer = time.Time;
							data.LeftTimer = left_timer;
						}
					}
					else if (side == 'right') {
						if ('RightTimer' in data) {
							delete data.RightTimer;
						}
						else {
							right_timer = time.Time;
							data.RightTimer = right_timer;
						}
					}

					send_with_errors(template_page, data);
				});
			});
		}

		/**
		 * start_custom_time starts the race timer with the specified initial time.
		 */
		let start_custom_time = function() {
			let sec = parseInt(get_val('starting-time-sec'));
			let min = parseInt(get_val('starting-time-min'));

			/* Ensure that the time is valid. */
			if (sec < 0) {
				sec = 0;
			}
			else if (sec >= 60) {
				sec = 59;
			}
			set_val('starting-time-sec', sec);

			if (min < 0) {
				min = 0;
			}
			else if (min >= 60) {
				min = 59;
			}
			set_val('starting-time-min', min);

			let initial_time = min * 60 + sec;
			timer.set(initial_time * 1000)
			timer.start();
		}

		/**
		 * start_countdown starts the pre-show countdown timer with the specified initial time.
		 */
		let start_countdown = function() {
			let sec = parseInt(get_val('countdown-time-sec'));
			let min = parseInt(get_val('countdown-time-min'));

			/* Ensure that the time is valid. */
			if (sec < 0) {
				sec = 0;
			}
			else if (sec >= 60) {
				sec = 59;
			}
			set_val('countdown-time-sec', sec);

			if (min < 0) {
				min = 0;
			}
			else if (min >= 60) {
				min = 59;
			}
			set_val('countdown-time-min', min);

			let countdown_time = min * 60 + sec;
			countdown_time = countdown_time * 1000;

			let _c = conn.newConn('/brat-handler/countdown', 'POST', true);
			_c.addHeader('Content-Type', 'application/json');
			_c.send(countdown_time, ignore_cb, function (e) { console.log(e); });
		}

		/**
		 * on_set_team automatically updates the team's <side>-racer select.
		 */
		let on_set_team = function(select) {
			let side = select.name.split('-')[0];
			let team_name = select.value;

			if (!(team_name in teams)) {
				console.error('Invalid team selected!');
				return;
			}

			let racer = document.getElementById(`${side}-racer`);
			while (racer.options.length > 0) {
				racer.options.remove(0);
			}
			for (i in teams[team_name]) {
				let name = teams[team_name][i];
				racer.options.add(new Option(name, name));
			}
		}

		/**
		 * configure_team_selector dynamically loads the team selector from the teams array.
		 */
		let configure_team_selector = function(team, set_event = true) {
			while (team.options.length > 0) {
				team.options.remove(0);
			}

			for (name in teams) {
				team.options.add(new Option(name, name));
			}

			if (set_event) {
				team.addEventListener('change', function(e) {on_set_team(e.target);});
				on_set_team(team);
			}
		}

		/**
		 * load_data loads the template data and call cb with it.
		 */
		let load_data = function (cb) {
			try {
				let _c = conn.newConn(template_page, 'GET', true);
				_c.addHeader('Accept', 'application/json');
				_c.send(null, cb, ignore_cb);
			} catch (e) {
				console.log(e);
			}
		}

		/**
		 * Request the data currently in the server, and fill the fields
		 * if possible.
		 */
		let on_boot = function (e) {
			configure_team_selector(document.getElementById('left-team'));
			configure_team_selector(document.getElementById('right-team'));
			configure_team_selector(document.getElementById('next-left-team'), false);
			configure_team_selector(document.getElementById('next-right-team'), false);

			load_data(on_load);
		}

		/**
		 * Register an event to retrieve when the page finished loading.
		 */
		document.addEventListener('DOMContentLoaded', on_boot);
		</script>

	</head>
	<body>
		<div class='vert'>
			<h1> Brat Masters Overlay Configuration </h1>

			<hr/>

			<div class='vert'>
				<h2> Race timer </h2>

				<div class='hor'>
					<input class='timer' onclick="start_time();" type="button" value="Start/Continue">
					<input class='timer' onclick="stop_time();" type="button" value="Stop">
					<input class='timer' onclick="reset_time();" type="button" value="Stop and Reset">
				</div>

				<div class='hor'>
					<input class='timer' onclick="start_custom_time();" type="button" value="Start from value">
					<input id='starting-time-min'
						class='set-time'
						name='starting-time'
						type='number'
						min='0'
						max='60'
						value='0'
						step='1'>
					<div class='vert' style='align-self: center; flex-grow: 1;'>
						<label style='text-align: center;'> : </label>
					</div>
					<input id='starting-time-sec'
						class='set-time'
						name='starting-time'
						type='number'
						min='0'
						max='60'
						value='0'
						step='1'>
				</div>

				<hr/>

				<div class='hor'>
					<input class='timer' onclick="toggle_time('left')" type="button" value="Pause/Continue Left Timer">
					<input class='timer' onclick="toggle_time('right')" type="button" value="Pause/Continue Right Timer">
				</div>
			</div>

			<hr/>

			<div class='vert'>
				<h2> Current race </h2>

				<input style='flex-grow: 1;' onclick="submit();" type="button" value="Update">

				<h3> Win count </h3>

				<div class='hor'>
					<label for='left-team-win-count'> Left Team (Red) Win Count: </label>
					<input id='left-team-win-count'
						name='left-team-win-count'
						type='number'
						min='0'
						value='0'
						step='1'>
				</div>

				<div class='hor'>
					<label for='right-team-win-count'> Right Team (Yellow) Win Count: </label>
					<input id='right-team-win-count'
						name='right-team-win-count'
						type='number'
						min='0'
						value='0'
						step='1'>
				</div>
			</div>

			<div class='vert'>
				<h3> Left Team (Red) </h3>

				<div class='hor'>
					<label for='left-racer'> Racer: </label>
					<select type='text' id='left-racer' name='left-racer'>
						<option value=""> -- Select a team -- </option>
					</select>
				</div>
				<div class='hor'>
					<label for='left-twitch'> Twitch channel (e.g., somerunner): </label>
					<input type='text' id='left-twitch' name='left-twitch'>
				</div>
			</div>

			<div class='vert'>
				<h3> Right Team (Yellow) </h3>

				<div class='hor'>
					<label for='right-racer'> Racer: </label>
					<select type='text' id='right-racer' name='right-racer'>
						<option value=""> -- Select a team -- </option>
					</select>
				</div>
				<div class='hor'>
					<label for='right-twitch'> Twitch channel (e.g., somerunner): </label>
					<input type='text' id='right-twitch' name='right-twitch'>
				</div>
			</div>

			<div class='vert'>
				<h3> Game </h3>

				<div class='hor'>
					<label for='game'> Game: </label>
					<input type='text' id='game' name='game'>
				</div>

				<div class='hor'>
					<label for='goal'> Goal: </label>
					<input type='text' id='goal' name='goal'>
				</div>
			</div>

			<hr/>

			<input style='flex-grow: 1;' onclick="submit();" type="button" value="Update">

			<div class='vert'>
				<h2> Match setup </h2>

				<h3> Match's teams </h3>

				<div class='hor'>
					<label for='left-team'> Left Team Name (Red): </label>
					<select type='text' id='left-team' name='left-team'>
						<option value=""> -- Teams --  </option>
					</select>
				</div>
				<div class='hor'>
					<label for='right-team'> Right Team (Yellow): </label>
					<select type='text' id='right-team' name='right-team'>
						<option value=""> -- Teams --  </option>
					</select>
				</div>
			</div>

			<div class='vert'>
				<h2> Pre-show setup </h2>

				<h3> Countdown timer </h3>

				<div class='hor'>
					<input class='timer' onclick="start_countdown();" type="button" value="Start countdown">
					<input id='countdown-time-min'
						class='set-time'
						name='countdown-time'
						type='number'
						min='0'
						max='60'
						value='0'
						step='1'>
					<div class='vert' style='align-self: center; flex-grow: 1;'>
						<label style='text-align: center;'> : </label>
					</div>
					<input id='countdown-time-sec'
						class='set-time'
						name='countdown-time'
						type='number'
						min='0'
						max='60'
						value='0'
						step='1'>
				</div>

				<h3> Next match </h3>

				<div class='hor'>
					<label for='next-left-team'> Left Team (Red): </label>
					<select type='text' id='next-left-team' name='next-left-team'>
						<option value=""> -- Teams --  </option>
					</select>
				</div>

				<div class='hor'>
					<label for='next-right-team'> Right Team (Yellow): </label>
					<select type='text' id='next-right-team' name='next-right-team'>
						<option value=""> -- Teams --  </option>
					</select>
				</div>
			<div class='vert'>

			<input style='flex-grow: 1;' onclick="submit();" type="button" value="Update">
	</body>
</html>
